/*
Online Student Management System - All in one Java file
Spring (Java Config) + Hibernate ORM + Transaction Management
Author: Example
Notes:
 - Save this file as OnlineStudentManagement.java
 - Provide hibernate.cfg.xml in resources (see comment below)
 - Use Maven and include dependencies (pom.xml snippet below)
*/

/* ---------------------------
   IMPORTS
   --------------------------- */
import org.springframework.context.annotation.*;
import org.springframework.transaction.annotation.EnableTransactionManagement;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.orm.hibernate5.HibernateTransactionManager;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;
import org.springframework.stereotype.Service;

import org.hibernate.SessionFactory;
import org.hibernate.Session;
import org.hibernate.cfg.Environment;
import org.hibernate.cfg.Configuration;

import javax.persistence.*;
import java.util.*;
import java.util.Date;
import java.text.SimpleDateFormat;

/* ---------------------------
   ENTITIES
   --------------------------- */

@Entity
@Table(name = "courses")
class Course {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer course_id;

    @Column(nullable = false, unique = true)
    private String course_name;

    @Column
    private String duration;

    public Course() {}
    public Course(String course_name, String duration) {
        this.course_name = course_name;
        this.duration = duration;
    }

    public Integer getCourse_id() { return course_id; }
    public String getCourse_name() { return course_name; }
    public String getDuration() { return duration; }

    public void setCourse_name(String course_name) { this.course_name = course_name; }
    public void setDuration(String duration) { this.duration = duration; }

    @Override
    public String toString() {
        return "Course{" + "id=" + course_id + ", name='" + course_name + '\'' + ", duration='" + duration + '\'' + '}';
    }
}

@Entity
@Table(name = "students")
class Student {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer student_id;

    @Column(nullable = false)
    private String name;

    // Many students can enroll in one course (simple mapping: many-to-one)
    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "course_id")
    private Course course;

    // Balance used for payments (for demo). In real app you'd use a separate wallet or payment records.
    @Column(nullable = false)
    private Double balance;

    public Student() {}
    public Student(String name, Course course, Double balance) {
        this.name = name;
        this.course = course;
        this.balance = balance;
    }

    public Integer getStudent_id() { return student_id; }
    public String getName() { return name; }
    public Course getCourse() { return course; }
    public Double getBalance() { return balance; }

    public void setName(String name) { this.name = name; }
    public void setCourse(Course course) { this.course = course; }
    public void setBalance(Double balance) { this.balance = balance; }

    @Override
    public String toString() {
        String cname = (course == null) ? "None" : course.getCourse_name();
        return "Student{" + "id=" + student_id + ", name='" + name + '\'' + ", course='" + cname + '\'' + ", balance=" + balance + '}';
    }
}

@Entity
@Table(name = "payments")
class Payment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer payment_id;

    @ManyToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = "student_id")
    private Student student;

    @Column(nullable = false)
    private Double amount;

    @Column(nullable = false)
    private Date date;

    @Column(nullable = false)
    private String type; // "PAYMENT" or "REFUND"

    public Payment() {}
    public Payment(Student student, Double amount, Date date, String type) {
        this.student = student;
        this.amount = amount;
        this.date = date;
        this.type = type;
    }

    public Integer getPayment_id() { return payment_id; }
    public Student getStudent() { return student; }
    public Double getAmount() { return amount; }
    public Date getDate() { return date; }
    public String getType() { return type; }

    public void setStudent(Student student) { this.student = student; }
    public void setAmount(Double amount) { this.amount = amount; }
    public void setDate(Date date) { this.date = date; }
    public void setType(String type) { this.type = type; }

    @Override
    public String toString() {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        return "Payment{" + "id=" + payment_id + ", student=" + (student != null ? student.getStudent_id() : null) + ", amount=" + amount + ", date=" + sdf.format(date) + ", type='" + type + '\'' + '}';
    }
}

/* ---------------------------
   DAO LAYER (Repositories)
   --------------------------- */

@Repository
class CourseDAO {
    @Autowired
    private SessionFactory sessionFactory;

    public Course save(Course c) {
        sessionFactory.getCurrentSession().save(c);
        return c;
    }

    public Course getById(int id) {
        return sessionFactory.getCurrentSession().get(Course.class, id);
    }

    public Course getByName(String name) {
        List<Course> list = sessionFactory.getCurrentSession()
                .createQuery("from Course where course_name = :name", Course.class)
                .setParameter("name", name)
                .getResultList();
        return list.isEmpty() ? null : list.get(0);
    }

    public List<Course> listAll() {
        return sessionFactory.getCurrentSession().createQuery("from Course", Course.class).getResultList();
    }

    public void delete(int id) {
        Course c = getById(id);
        if (c != null) sessionFactory.getCurrentSession().delete(c);
    }
}

@Repository
class StudentDAO {
    @Autowired
    private SessionFactory sessionFactory;

    public Student save(Student s) {
        sessionFactory.getCurrentSession().save(s);
        return s;
    }

    public Student update(Student s) {
        sessionFactory.getCurrentSession().update(s);
        return s;
    }

    public Student getById(int id) {
        return sessionFactory.getCurrentSession().get(Student.class, id);
    }

    public List<Student> listAll() {
        return sessionFactory.getCurrentSession().createQuery("from Student", Student.class).getResultList();
    }

    public void delete(int id) {
        Student s = getById(id);
        if (s != null) sessionFactory.getCurrentSession().delete(s);
    }
}

@Repository
class PaymentDAO {
    @Autowired
    private SessionFactory sessionFactory;

    public Payment save(Payment p) {
        sessionFactory.getCurrentSession().save(p);
        return p;
    }

    public List<Payment> listByStudent(int studentId) {
        return sessionFactory.getCurrentSession()
                .createQuery("from Payment where student.student_id = :sid order by date desc", Payment.class)
                .setParameter("sid", studentId)
                .getResultList();
    }
}

/* ---------------------------
   SERVICE LAYER (Transactional)
   --------------------------- */

@Service
class StudentService {
    @Autowired
    private StudentDAO studentDAO;

    @Autowired
    private CourseDAO courseDAO;

    @Autowired
    private PaymentDAO paymentDAO;

    // CRUD operations
    @Transactional
    public Student addStudent(String name, Integer courseId, Double balance) {
        Course course = (courseId == null) ? null : courseDAO.getById(courseId);
        Student s = new Student(name, course, balance == null ? 0.0 : balance);
        return studentDAO.save(s);
    }

    @Transactional
    public Student updateStudent(int id, String name, Integer courseId, Double balance) {
        Student s = studentDAO.getById(id);
        if (s == null) throw new RuntimeException("Student not found with id " + id);
        if (name != null && !name.trim().isEmpty()) s.setName(name);
        if (courseId != null) s.setCourse(courseDAO.getById(courseId));
        if (balance != null) s.setBalance(balance);
        return studentDAO.update(s);
    }

    @Transactional
    public void deleteStudent(int id) {
        studentDAO.delete(id);
    }

    @Transactional(readOnly = true)
    public Student getStudent(int id) {
        return studentDAO.getById(id);
    }

    @Transactional(readOnly = true)
    public List<Student> listStudents() {
        return studentDAO.listAll();
    }

    @Transactional
    public Course addCourse(String name, String duration) {
        Course existing = courseDAO.getByName(name);
        if (existing != null) throw new RuntimeException("Course already exists with name: " + name);
        Course c = new Course(name, duration);
        return courseDAO.save(c);
    }

    @Transactional(readOnly = true)
    public List<Course> listCourses() {
        return courseDAO.listAll();
    }

    @Transactional
    public void deleteCourse(int id) {
        courseDAO.delete(id);
    }

    // Transactional payment: deducts from student balance and records payment
    // If any failure occurs (e.g., insufficient balance or DB error), rollback occurs.
    @Transactional
    public Payment payFee(int studentId, double amount) {
        Student student = studentDAO.getById(studentId);
        if (student == null) throw new RuntimeException("Student not found: " + studentId);

        // simulate payment by deducting from balance (for demo)
        if (student.getBalance() < amount) throw new RuntimeException("Insufficient balance for student " + studentId);

        student.setBalance(student.getBalance() - amount);
        studentDAO.update(student);

        Payment p = new Payment(student, amount, new Date(), "PAYMENT");
        paymentDAO.save(p);

        // success
        return p;
    }

    @Transactional
    public Payment refundFee(int studentId, double amount) {
        Student student = studentDAO.getById(studentId);
        if (student == null) throw new RuntimeException("Student not found: " + studentId);

        // For refund we add to balance and record a REFUND
        student.setBalance(student.getBalance() + amount);
        studentDAO.update(student);

        Payment p = new Payment(student, amount, new Date(), "REFUND");
        paymentDAO.save(p);

        return p;
    }

    @Transactional(readOnly = true)
    public List<Payment> getPayments(int studentId) {
        return paymentDAO.listByStudent(studentId);
    }
}

/* ---------------------------
   SPRING JAVA CONFIG
   --------------------------- */

@Configuration
@ComponentScan(basePackages = {"",}) // default package; scanning file's package
@EnableTransactionManagement
class AppConfig {

    @Bean
    public SessionFactory sessionFactory() {
        // Build configuration programmatically (but also supports hibernate.cfg.xml if preferred)
        try {
            Configuration cfg = new Configuration();

            // try to load hibernate.cfg.xml from resources if present (preferred)
            try {
                cfg.configure("hibernate.cfg.xml");
            } catch (Exception e) {
                // fallback if file not present; you may set properties here
                Properties props = new Properties();
                props.put(Environment.DRIVER, "com.mysql.cj.jdbc.Driver");
                props.put(Environment.URL, "jdbc:mysql://localhost:3306/springdb?useSSL=false&serverTimezone=UTC");
                props.put(Environment.USER, "root");
                props.put(Environment.PASS, "password");
                props.put(Environment.DIALECT, "org.hibernate.dialect.MySQL8Dialect");
                props.put(Environment.HBM2DDL_AUTO, "update");
                props.put(Environment.SHOW_SQL, "true");
                props.put(Environment.CURRENT_SESSION_CONTEXT_CLASS, "thread");
                cfg.setProperties(props);
            }

            // add annotated classes
            cfg.addAnnotatedClass(Student.class);
            cfg.addAnnotatedClass(Course.class);
            cfg.addAnnotatedClass(Payment.class);

            return cfg.buildSessionFactory();
        } catch (Throwable ex) {
            System.err.println("SessionFactory creation failed: " + ex);
            throw new ExceptionInInitializerError(ex);
        }
    }

    @Bean
    public HibernateTransactionManager transactionManager(SessionFactory sessionFactory) {
        HibernateTransactionManager htm = new HibernateTransactionManager();
        htm.setSessionFactory(sessionFactory);
        return htm;
    }
}

/* ---------------------------
   MAIN APP (Console interface)
   --------------------------- */

public class MainApp {
    private static Scanner sc = new Scanner(System.in);

    public static void main(String[] args) {
        AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext(AppConfig.class);
        StudentService service = ctx.getBean(StudentService.class);

        System.out.println("=== Online Student Management System (Console) ===");
        boolean exit = false;
        while (!exit) {
            printMenu();
            String choice = sc.nextLine().trim();
            try {
                switch (choice) {
                    case "1": addCourse(service); break;
                    case "2": listCourses(service); break;
                    case "3": addStudent(service); break;
                    case "4": listStudents(service); break;
                    case "5": viewStudent(service); break;
                    case "6": updateStudent(service); break;
                    case "7": deleteStudent(service); break;
                    case "8": payFee(service); break;
                    case "9": refundFee(service); break;
                    case "10": viewPayments(service); break;
                    case "0": exit = true; break;
                    default: System.out.println("Invalid option. Try again.");
                }
            } catch (Exception e) {
                System.out.println("Error: " + e.getMessage());
            }
        }

        ctx.close();
        System.out.println("Exited. Bye!");
    }

    private static void printMenu() {
        System.out.println("\nChoose operation:");
        System.out.println("1. Add Course");
        System.out.println("2. List Courses");
        System.out.println("3. Add Student");
        System.out.println("4. List Students");
        System.out.println("5. View Student by ID");
        System.out.println("6. Update Student");
        System.out.println("7. Delete Student");
        System.out.println("8. Pay Fee");
        System.out.println("9. Refund Fee");
        System.out.println("10. View Payments for Student");
        System.out.println("0. Exit");
        System.out.print("Enter option: ");
    }

    private static void addCourse(StudentService service) {
        System.out.print("Course Name: ");
        String name = sc.nextLine().trim();
        System.out.print("Duration (e.g., 3 months): ");
        String duration = sc.nextLine().trim();
        Course c = service.addCourse(name, duration);
        System.out.println("Added: " + c);
    }

    private static void listCourses(StudentService service) {
        List<Course> courses = service.listCourses();
        if (courses.isEmpty()) System.out.println("No courses found.");
        else courses.forEach(System.out::println);
    }

    private static void addStudent(StudentService service) {
        System.out.print("Student Name: ");
        String name = sc.nextLine().trim();
        System.out.print("Course ID (or blank for none): ");
        String c = sc.nextLine().trim();
        Integer courseId = c.isEmpty() ? null : Integer.parseInt(c);
        System.out.print("Initial Balance (e.g., 1000): ");
        String b = sc.nextLine().trim();
        Double balance = b.isEmpty() ? 0.0 : Double.parseDouble(b);
        Student s = service.addStudent(name, courseId, balance);
        System.out.println("Added Student: " + s);
    }

    private static void listStudents(StudentService service) {
        List<Student> students = service.listStudents();
        if (students.isEmpty()) System.out.println("No students found.");
        else students.forEach(System.out::println);
    }

    private static void viewStudent(StudentService service) {
        System.out.print("Enter Student ID: ");
        int id = Integer.parseInt(sc.nextLine().trim());
        Student s = service.getStudent(id);
        if (s == null) System.out.println("Student not found.");
        else System.out.println(s);
    }

    private static void updateStudent(StudentService service) {
        System.out.print("Student ID to update: ");
        int id = Integer.parseInt(sc.nextLine().trim());
        System.out.print("New name (blank to keep current): ");
        String name = sc.nextLine().trim();
        System.out.print("New Course ID (blank to keep current): ");
        String c = sc.nextLine().trim();
        Integer courseId = c.isEmpty() ? null : Integer.parseInt(c);
        System.out.print("New Balance (blank to keep current): ");
        String b = sc.nextLine().trim();
        Double balance = b.isEmpty() ? null : Double.parseDouble(b);
        Student s = service.updateStudent(id, name.isEmpty() ? null : name, courseId, balance);
        System.out.println("Updated: " + s);
    }

    private static void deleteStudent(StudentService service) {
        System.out.print("Student ID to delete: ");
        int id = Integer.parseInt(sc.nextLine().trim());
        service.deleteStudent(id);
        System.out.println("Student deleted (if existed).");
    }

    private static void payFee(StudentService service) {
        System.out.print("Student ID: ");
        int id = Integer.parseInt(sc.nextLine().trim());
        System.out.print("Amount to pay: ");
        double
